name: CI

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure
        run: cmake -S . -B build -G "MinGW Makefiles" -DCMAKE_C_COMPILER=clang

      - name: Build
        run: cmake --build build

      - name: Smoke test
        shell: pwsh
        run: |
          $proc = Start-Process -FilePath ".\\build\\c_fullstack_server.exe" -ArgumentList "--db-config", ".\\server\\db.conf", "--port", "8091" -PassThru
          Start-Sleep -Seconds 2
          try {
            $health = Invoke-WebRequest -Uri "http://localhost:8091/api/health" -UseBasicParsing
            if ($health.StatusCode -ne 200) {
              throw "Unexpected status code: $($health.StatusCode)"
            }
          }
          finally {
            if ($proc -and -not $proc.HasExited) {
              Stop-Process -Id $proc.Id -Force
            }
          }

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential libsqlite3-dev

      - name: Configure
        run: cmake -S . -B build -DUSE_BUNDLED_SQLITE=ON

      - name: Build
        run: cmake --build build

      - name: Smoke test
        run: |
          timeout 3 ./build/c_fullstack_server --db-config ./server/db.conf --port 8091 &
          sleep 1
          curl http://localhost:8091/api/health || exit 1
